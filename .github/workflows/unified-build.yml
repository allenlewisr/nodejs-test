on:
  workflow_dispatch:
  push:
    branches:
      - main
      - 'release/**'

name: Build and Release

env:
  NODE_VERSION: '22.21'
  JFROG_REPO_NAME: '' # JFrog repo name to upload the artifact to(default: <repo-name>-npm-dev-local)
  JFROG_REMOTE_REPO_NAME: 'npm-remote' # JFrog remote repo name to resolve the artifact from
  JFROG_SECURITY_REPO_NAME: '' # JFrog repo for security artifacts (default: <repo-name>-security-local)
  BUILD_NAME: '' # Build name to upload to JFrog(default: <repo-name>)

permissions:
  id-token: write
  contents: read
  attestations: write
  security-events: write

jobs:
  build:
    name: Build and Publish
    runs-on: ubuntu-latest
    outputs:
      build_name: ${{ steps.setup-build-env.outputs.build_name }}
      jfrog_repo_name: ${{ steps.setup-build-env.outputs.jfrog_repo_name }}
      jfrog_security_repo_name: ${{ steps.setup-build-env.outputs.jfrog_security_repo_name }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Setup node ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v6
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v4
      with:
        languages: javascript
        queries: security-and-quality

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v4
      with:
        category: "/language:javascript"
        output: codeql-results
        upload: false

    - name: Setup JFrog CLI
      uses: jfrog/setup-jfrog-cli@v4
      env:  
        JF_URL: ${{ vars.ARTIFACTORY_URL }}
        JF_ACCESS_TOKEN: ${{ secrets.JFROG_ACCESS_TOKEN }}
    
    - name: Test connection
      run: |
        jf rt ping

    - name: Setup build name and JFrog repository name
      id: setup-build-env
      run: |
        if [ -n "${{ env.BUILD_NAME }}" ]; then
          BUILD_NAME_VALUE="${{ env.BUILD_NAME }}"
        else
          BUILD_NAME_VALUE="${{ github.event.repository.name }}"
        fi
        echo "BUILD_NAME=${BUILD_NAME_VALUE}" >> $GITHUB_ENV
        echo "JFROG_CLI_BUILD_NAME=${BUILD_NAME_VALUE}" >> $GITHUB_ENV
        echo "JFROG_CLI_BUILD_NUMBER=${{ github.run_number }}" >> $GITHUB_ENV
        echo "build_name=${BUILD_NAME_VALUE}" >> $GITHUB_OUTPUT

        if [ -n "${{ env.JFROG_REPO_NAME }}" ]; then
          JFROG_REPO_NAME_VALUE="${{ env.JFROG_REPO_NAME }}"
        else
          JFROG_REPO_NAME_VALUE="${{ github.event.repository.name }}-npm-local-dev"
        fi
        echo "JFROG_REPO_NAME=${JFROG_REPO_NAME_VALUE}" >> $GITHUB_ENV
        echo "jfrog_repo_name=${JFROG_REPO_NAME_VALUE}" >> $GITHUB_OUTPUT

        if [ -n "${{ env.JFROG_SECURITY_REPO_NAME }}" ]; then
          JFROG_SECURITY_REPO_NAME_VALUE="${{ env.JFROG_SECURITY_REPO_NAME }}"
        else
          JFROG_SECURITY_REPO_NAME_VALUE="${{ github.event.repository.name }}-security-local"
        fi
        echo "JFROG_SECURITY_REPO_NAME=${JFROG_SECURITY_REPO_NAME_VALUE}" >> $GITHUB_ENV
        echo "jfrog_security_repo_name=${JFROG_SECURITY_REPO_NAME_VALUE}" >> $GITHUB_OUTPUT
    
    - name: Setup npm registry
      run: |
        jf npm-config \
          --repo-resolve=${{ env.JFROG_REMOTE_REPO_NAME }} \
          --repo-deploy=${{ env.JFROG_REPO_NAME }}
    
    - name: npm install
      run: |
        jf npm ci --build-name=${{ env.BUILD_NAME }} --build-number=${{ github.run_number }}
    
    - name: npm run lint
      run: |
        jf npm run lint --build-name=${{ env.BUILD_NAME }} --build-number=${{ github.run_number }}
        jf npm run format:check --build-name=${{ env.BUILD_NAME }} --build-number=${{ github.run_number }}
    
    - name: Verify JFrog Repositories Exist
      run: |
        echo "Checking if JFrog repository '${{ env.JFROG_REPO_NAME }}' exists..."
        if jf rt curl -XGET "/api/repositories/${{ env.JFROG_REPO_NAME }}" --silent --fail > /dev/null 2>&1; then
          echo "✓ Repository '${{ env.JFROG_REPO_NAME }}' exists"
        else
          echo "✗ ERROR: Repository '${{ env.JFROG_REPO_NAME }}' does not exist in JFrog Artifactory"
          echo "Please create the repository before publishing the package"
          exit 1
        fi

        echo "Checking if JFrog security repository '${{ env.JFROG_SECURITY_REPO_NAME }}' exists..."
        if jf rt curl -XGET "/api/repositories/${{ env.JFROG_SECURITY_REPO_NAME }}" --silent --fail > /dev/null 2>&1; then
          echo "✓ Repository '${{ env.JFROG_SECURITY_REPO_NAME }}' exists"
        else
          echo "✗ ERROR: Repository '${{ env.JFROG_SECURITY_REPO_NAME }}' does not exist in JFrog Artifactory"
          echo "Please create the security repository as a Generic repository type"
          exit 1
        fi

    - name: Generate package tarball path
      run: |
        PACKAGE_NAME=$(node -p "require('./package.json').name")
        PACKAGE_VERSION=$(node -p "require('./package.json').version")
        SHORT_SHA="${GITHUB_SHA:0:8}"
        TARBALL_NAME="${PACKAGE_NAME}-${PACKAGE_VERSION}.tgz"
        # npm publish creates path: repo-name/package-name/-/tarball.tgz
        NPM_ARTIFACT_PATH="${PACKAGE_NAME}/-/${TARBALL_NAME}"
        echo "PACKAGE_NAME=${PACKAGE_NAME}" >> $GITHUB_ENV
        echo "TARBALL_PATH=${TARBALL_NAME}" >> $GITHUB_ENV
        echo "NPM_ARTIFACT_PATH=${NPM_ARTIFACT_PATH}" >> $GITHUB_ENV
        echo "SHORT_SHA=${SHORT_SHA}" >> $GITHUB_ENV
        echo "Package tarball: ${TARBALL_NAME}"
        echo "NPM artifact path: ${NPM_ARTIFACT_PATH}"
        echo "Git SHA: ${SHORT_SHA} (will be stored in artifact properties)"

    - name: Create package tarball
      run: |
        jf npm pack
        ls -lh ${{ env.TARBALL_PATH }}

    - name: Scan package for vulnerabilities
      run: |
        if ! jf audit \
          --format=table \
          --npm \
            --watches SecurityWatch \
            --fail; then
          echo "✗ ERROR: Vulnerabilities found in package"
          echo "Please fix the vulnerabilities before publishing the package"
          exit 1
        fi

    - name: Publish to JFrog Artifactory
      run: |
        jf npm publish --build-name=${{ env.BUILD_NAME }} --build-number=${{ github.run_number }}

    - name: Download published package for attestation
      run: |
        # Download the actual published package from JFrog for attestation
        # This ensures we attest the exact file stored in JFrog
        JFROG_ARTIFACT_PATH="${{ env.JFROG_REPO_NAME }}/${{ env.NPM_ARTIFACT_PATH }}"
        echo "Downloading published package from: ${JFROG_ARTIFACT_PATH}"
        
        jf rt download "${JFROG_ARTIFACT_PATH}" --flat
        
        if [ ! -f "${{ env.TARBALL_PATH }}" ]; then
          echo "❌ Failed to download published package"
          exit 1
        fi
        
        echo "✓ Published package downloaded for attestation"
        ls -lh ${{ env.TARBALL_PATH }}
        
        # Calculate and display the digest for verification
        DIGEST=$(sha256sum ${{ env.TARBALL_PATH }} | awk '{print $1}')
        echo "Package SHA256: ${DIGEST}"

    - name: Attest package with GitHub
      id: attest
      uses: actions/attest-build-provenance@v3
      with:
        subject-path: '${{ env.TARBALL_PATH }}'

    - name: Create custom attestation with actor info
      id: attest-actor
      uses: actions/attest@v2
      with:
        subject-path: '${{ env.TARBALL_PATH }}'
        predicate-type: 'https://github.com/attestation/actor/v1'
        predicate: |
          {
            "actor": "${{ github.actor }}",
            "actorId": "${{ github.actor_id }}",
            "repository": "${{ github.repository }}",
            "repositoryOwner": "${{ github.repository_owner }}",
            "commit": "${{ github.sha }}",
            "ref": "${{ github.ref }}",
            "workflow": "${{ github.workflow }}",
            "workflowRef": "${{ github.workflow_ref }}",
            "runId": "${{ github.run_id }}",
            "runNumber": "${{ github.run_number }}",
            "runAttempt": "${{ github.run_attempt }}",
            "timestamp": "${{ github.event.head_commit.timestamp }}"
          }

    - name: Add attestation metadata to JFrog artifact
      run: |
        # Add properties to the uploaded artifact in JFrog (using npm publish path structure)
        ARTIFACT_PATH="${{ env.JFROG_REPO_NAME }}/${{ env.NPM_ARTIFACT_PATH }}"
        
        echo "Setting properties on: ${ARTIFACT_PATH}"
        jf rt set-props "${ARTIFACT_PATH}" \
          "git.commit.sha=${{ github.sha }};git.commit.short=${{ env.SHORT_SHA }};git.branch=${{ github.ref_name }};build.name=${{ env.BUILD_NAME }};build.number=${{ github.run_number }};attestation.github.url=https://github.com/${{ github.repository }}/attestations;attestation.actor=${{ github.actor }};attestation.trigger=${{ github.event_name }};attestation.commit=${{ github.sha }};attestation.provenance.bundle=${{ steps.attest.outputs.bundle-path }};attestation.actor.bundle=${{ steps.attest-actor.outputs.bundle-path }};attestation.sigstore.enabled=true;security.repo=${{ env.JFROG_SECURITY_REPO_NAME }}"
        
        echo "✓ Attestation metadata added to artifact in JFrog"
        echo "  Artifact: ${ARTIFACT_PATH}"
        echo "  Git SHA: ${{ env.SHORT_SHA }}"
        echo "  Build: ${{ env.BUILD_NAME }}/${{ github.run_number }}"

    - name: Find CodeQL SARIF results
      id: sarif-info
      run: |
        SARIF_FILE=$(find codeql-results -name "*.sarif" -type f | head -n 1)
        if [ -z "$SARIF_FILE" ]; then
          echo "Error: No SARIF file found"
          exit 1
        fi
        echo "SARIF_FILE=$SARIF_FILE" >> $GITHUB_ENV
        echo "Found SARIF file: $SARIF_FILE"
        
        # Generate SARIF filename for JFrog (using build number for uniqueness)
        SARIF_JFROG_NAME="${{ env.BUILD_NAME }}-codeql-${{ github.run_number }}.sarif"
        echo "SARIF_JFROG_NAME=$SARIF_JFROG_NAME" >> $GITHUB_ENV
        echo "JFrog SARIF name: $SARIF_JFROG_NAME"

    - name: Attest CodeQL SARIF results
      id: attest-codeql
      uses: actions/attest@v2
      with:
        subject-path: '${{ env.SARIF_FILE }}'
        predicate-type: 'https://github.com/attestation/codeql/v1'
        predicate: |
          {
            "scanType": "codeql",
            "language": "javascript",
            "queries": "security-and-quality",
            "repository": "${{ github.repository }}",
            "commit": "${{ github.sha }}",
            "ref": "${{ github.ref }}",
            "workflow": "${{ github.workflow }}",
            "runId": "${{ github.run_id }}",
            "runNumber": "${{ github.run_number }}",
            "timestamp": "${{ github.event.head_commit.timestamp }}",
            "resultsFile": "${{ env.SARIF_FILE }}"
          }

    - name: Upload CodeQL SARIF to JFrog
      run: |
        cp "${{ env.SARIF_FILE }}" "${{ env.SARIF_JFROG_NAME }}"
        
        jf rt upload "${{ env.SARIF_JFROG_NAME }}" "${{ env.JFROG_SECURITY_REPO_NAME }}/" \
          --build-name=${{ env.BUILD_NAME }} \
          --build-number=${{ github.run_number }} \
          --module=${{ env.BUILD_NAME }}-security
        
        echo "✓ CodeQL SARIF uploaded to JFrog security repository"

    - name: Add CodeQL attestation metadata to SARIF in JFrog
      run: |
        SARIF_ARTIFACT_PATH="${{ env.JFROG_SECURITY_REPO_NAME }}/${{ env.SARIF_JFROG_NAME }}"
        
        jf rt set-props "${SARIF_ARTIFACT_PATH}" \
          "git.commit.sha=${{ github.sha }};git.commit.short=${{ env.SHORT_SHA }};git.branch=${{ github.ref_name }};build.name=${{ env.BUILD_NAME }};build.number=${{ github.run_number }};scan.type=codeql;scan.language=javascript;attestation.codeql.bundle=${{ steps.attest-codeql.outputs.bundle-path }};attestation.github.url=https://github.com/${{ github.repository }}/attestations;attestation.commit=${{ github.sha }};attestation.sigstore.enabled=true;related.artifact=${{ env.TARBALL_PATH }};related.package.repo=${{ env.JFROG_REPO_NAME }}"
        
        echo "✓ CodeQL attestation metadata added to SARIF in JFrog"
        echo "✓ SARIF file location: ${SARIF_ARTIFACT_PATH}"

    - name: Link package to SARIF security artifact
      run: |
        # Add bidirectional link from package to its SARIF file
        ARTIFACT_PATH="${{ env.JFROG_REPO_NAME }}/${{ env.NPM_ARTIFACT_PATH }}"
        
        jf rt set-props "${ARTIFACT_PATH}" \
          "security.sarif.file=${{ env.SARIF_JFROG_NAME }};security.sarif.path=${{ env.JFROG_SECURITY_REPO_NAME }}/${{ env.SARIF_JFROG_NAME }};security.scan.type=codeql;security.scan.language=javascript;security.scan.attestation=${{ steps.attest-codeql.outputs.bundle-path }}"
        
        echo "✓ Package linked to SARIF security artifact"
        echo "✓ Package: ${ARTIFACT_PATH}"
        echo "✓ SARIF: ${{ env.JFROG_SECURITY_REPO_NAME }}/${{ env.SARIF_JFROG_NAME }}"

    - name: Generate SBOM
      id: generate-sbom
      run: |
        SBOM_JFROG_NAME="${{ env.BUILD_NAME }}-sbom-${{ github.run_number }}.json"
        
        echo "Generating SBOM in CycloneDX format..."
        jf npm sbom --sbom-format=cyclonedx > "$SBOM_JFROG_NAME"
        
        echo "SBOM_JFROG_NAME=$SBOM_JFROG_NAME" >> $GITHUB_ENV
        echo "✓ SBOM generated: $SBOM_JFROG_NAME"
        
        # Display SBOM summary
        if command -v jq &> /dev/null; then
          COMPONENT_COUNT=$(jq '.components | length' "$SBOM_JFROG_NAME" 2>/dev/null || echo "unknown")
          echo "  Components: $COMPONENT_COUNT"
        fi

    - name: Attest SBOM
      id: attest-sbom
      uses: actions/attest@v2
      with:
        subject-path: '${{ env.SBOM_JFROG_NAME }}'
        predicate-type: 'https://cyclonedx.org/bom'
        predicate: |
          {
            "format": "CycloneDX",
            "version": "1.5",
            "repository": "${{ github.repository }}",
            "commit": "${{ github.sha }}",
            "ref": "${{ github.ref }}",
            "workflow": "${{ github.workflow }}",
            "runId": "${{ github.run_id }}",
            "runNumber": "${{ github.run_number }}",
            "timestamp": "${{ github.event.head_commit.timestamp }}",
            "package": "${{ env.TARBALL_PATH }}"
          }

    - name: Upload SBOM to JFrog
      run: |
        jf rt upload "${{ env.SBOM_JFROG_NAME }}" "${{ env.JFROG_SECURITY_REPO_NAME }}/" \
          --build-name=${{ env.BUILD_NAME }} \
          --build-number=${{ github.run_number }} \
          --module=${{ env.BUILD_NAME }}-security
        
        echo "✓ SBOM uploaded to JFrog security repository"

    - name: Add SBOM attestation metadata to JFrog
      run: |
        SBOM_ARTIFACT_PATH="${{ env.JFROG_SECURITY_REPO_NAME }}/${{ env.SBOM_JFROG_NAME }}"
        
        jf rt set-props "${SBOM_ARTIFACT_PATH}" \
          "git.commit.sha=${{ github.sha }};git.commit.short=${{ env.SHORT_SHA }};git.branch=${{ github.ref_name }};build.name=${{ env.BUILD_NAME }};build.number=${{ github.run_number }};sbom.format=cyclonedx;sbom.type=software-bill-of-materials;attestation.sbom.bundle=${{ steps.attest-sbom.outputs.bundle-path }};attestation.github.url=https://github.com/${{ github.repository }}/attestations;attestation.commit=${{ github.sha }};attestation.sigstore.enabled=true;related.artifact=${{ env.TARBALL_PATH }};related.package.repo=${{ env.JFROG_REPO_NAME }}"
        
        echo "✓ SBOM attestation metadata added to JFrog"
        echo "✓ SBOM file location: ${SBOM_ARTIFACT_PATH}"

    - name: Link package to SBOM security artifact
      run: |
        # Add bidirectional link from package to its SBOM file
        ARTIFACT_PATH="${{ env.JFROG_REPO_NAME }}/${{ env.NPM_ARTIFACT_PATH }}"
        
        jf rt set-props "${ARTIFACT_PATH}" \
          "security.sbom.file=${{ env.SBOM_JFROG_NAME }};security.sbom.path=${{ env.JFROG_SECURITY_REPO_NAME }}/${{ env.SBOM_JFROG_NAME }};security.sbom.format=cyclonedx;security.sbom.attestation=${{ steps.attest-sbom.outputs.bundle-path }}"
        
        echo "✓ Package linked to SBOM security artifact"
        echo "✓ Package: ${ARTIFACT_PATH}"
        echo "✓ SBOM: ${{ env.JFROG_SECURITY_REPO_NAME }}/${{ env.SBOM_JFROG_NAME }}"

    - name: Publish build-info to JFrog
      run: |
        jf rt build-publish --collect-env --collect-git-info ${{ env.BUILD_NAME }} ${{ github.run_number }}

  release-bundle:
    name: Create Release Bundle
    runs-on: ubuntu-latest
    needs: [build]
    if: startsWith(github.ref, 'refs/heads/release/') && github.actor != 'dependabot[bot]' && github.actor != 'dependabot'
    environment: DEV
    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Setup node ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v6
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: Setup JFrog CLI
      uses: jfrog/setup-jfrog-cli@v4
      env:  
        JF_URL: ${{ vars.ARTIFACTORY_URL }}
        JF_ACCESS_TOKEN: ${{ secrets.JFROG_ACCESS_TOKEN }}
    
    - name: Test connection
      run: |
        jf rt ping

    - name: Set build environment from build job
      run: |
        echo "BUILD_NAME=${{ needs.build.outputs.build_name }}" >> $GITHUB_ENV
        echo "JFROG_CLI_BUILD_NAME=${{ needs.build.outputs.build_name }}" >> $GITHUB_ENV
        echo "JFROG_CLI_BUILD_NUMBER=${{ github.run_number }}" >> $GITHUB_ENV
        echo "JFROG_REPO_NAME=${{ needs.build.outputs.jfrog_repo_name }}" >> $GITHUB_ENV
        echo "JFROG_SECURITY_REPO_NAME=${{ needs.build.outputs.jfrog_security_repo_name }}" >> $GITHUB_ENV

    - name: Extract version from branch name
      run: |
        if [[ "${{ github.ref }}" == refs/heads/release/* ]]; then
          VERSION=${GITHUB_REF#refs/heads/release/}
          echo "PACKAGE_VERSION=${VERSION}" >> $GITHUB_ENV
          echo "PACKAGE_VERSION=${VERSION}"
        else
          echo "Error: Not a release branch"
          exit 1
        fi

    - name: Generate bundle version
      run: |
        echo "BUNDLE_VERSION=${{ env.PACKAGE_VERSION }}+build.${{ github.run_number }}" >> $GITHUB_ENV

    - name: Create release bundle
      run: |
        jf rbc --build-name=${{ env.BUILD_NAME }} --build-number=${{ github.run_number }} ${{ env.BUILD_NAME }} ${{ env.BUNDLE_VERSION }}

    - name: Promote release bundle to dev
      run: |
        jf rbp --include-repos "${{ env.JFROG_REPO_NAME }};${{ env.JFROG_SECURITY_REPO_NAME }}" ${{ env.BUILD_NAME}} ${{ env.BUNDLE_VERSION }} DEV

    - name: Calculate bundle digest for attestation
      id: bundle-digest
      run: |
        # Create a stable representation of the bundle for attestation
        bundle_subject="${{ env.BUILD_NAME }}:${{ env.BUNDLE_VERSION }}"
        bundle_digest=$(echo -n "$bundle_subject" | sha256sum | awk '{print $1}')
        echo "bundle_digest=${bundle_digest}" >> $GITHUB_OUTPUT
        echo "Bundle digest: ${bundle_digest}"

    - name: Fetch approval information
      id: get-approvers
      run: |
        # Fetch approvers from GitHub API
        APPROVERS=$(gh api repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/approvals \
          --jq '[.[] | .user.login] | join(",")' 2>/dev/null || echo "")
        
        if [ -z "$APPROVERS" ]; then
          echo "No approvals found (environment may not require reviewers)"
          echo "approvers=automatic" >> $GITHUB_OUTPUT
        else
          echo "Approved by: ${APPROVERS}"
          echo "approvers=${APPROVERS}" >> $GITHUB_OUTPUT
        fi
      env:
        GH_TOKEN: ${{ github.token }}

    - name: Create initial promotion attestation
      id: attest-promotion
      uses: actions/attest@v2
      with:
        subject-name: "${{ env.BUILD_NAME }}/${{ env.BUNDLE_VERSION }} - BUILD -> DEV"
        subject-digest: "sha256:${{ steps.bundle-digest.outputs.bundle_digest }}"
        predicate-type: 'https://github.com/attestation/promotion/v1'
        predicate: |
          {
            "triggeredBy": "${{ github.actor }}",
            "triggeredById": "${{ github.actor_id }}",
            "approvedBy": "${{ steps.get-approvers.outputs.approvers }}",
            "sourceEnvironment": "BUILD",
            "targetEnvironment": "DEV",
            "bundleName": "${{ env.BUILD_NAME }}",
            "bundleVersion": "${{ env.BUNDLE_VERSION }}",
            "repository": "${{ github.repository }}",
            "repositoryOwner": "${{ github.repository_owner }}",
            "workflow": "${{ github.workflow }}",
            "workflowRef": "${{ github.workflow_ref }}",
            "workflowRunId": "${{ github.run_id }}",
            "workflowRunNumber": "${{ github.run_number }}",
            "workflowRunAttempt": "${{ github.run_attempt }}",
            "timestamp": "${{ github.event.head_commit.timestamp }}",
            "verificationUrl": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          }

    - name: Log promotion attestation
      run: |
        echo "✓ Initial promotion attestation created"
        echo "Bundle: ${{ env.BUILD_NAME }} v${{ env.BUNDLE_VERSION }}"
        echo "Promotion: BUILD → DEV"
        echo "Triggered by: ${{ github.actor }}"
        echo "Attestation bundle: ${{ steps.attest-promotion.outputs.bundle-path }}"
        echo ""
        echo "View attestation at: https://github.com/${{ github.repository }}/attestations"

