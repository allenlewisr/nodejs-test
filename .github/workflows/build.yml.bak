on:
  workflow_dispatch:

name: Build

env:
  NODE_VERSION: '22.21'
  JFROG_REPO_NAME: '' # JFrog repo name to upload the artifact to(default: <repo-name>-npm-dev-local)
  JFROG_REMOTE_REPO_NAME: 'npm-remote' # JFrog remote repo name to resolve the artifact from
  JFROG_SECURITY_REPO_NAME: '' # JFrog repo for security artifacts (default: <repo-name>-security-local)
  BUILD_NAME: '' # Build name to upload to JFrog(default: <repo-name>)

permissions:
  id-token: write
  contents: read
  attestations: write
  security-events: write

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Setup node ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v6
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v4
      with:
        languages: javascript
        queries: security-and-quality

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v4
      with:
        category: "/language:javascript"
        output: codeql-results
        upload: false

    - name: Setup JFrog CLI
      uses: jfrog/setup-jfrog-cli@v4
      env:  
        JF_URL: ${{ vars.ARTIFACTORY_URL }}
        JF_ACCESS_TOKEN: ${{ secrets.JFROG_ACCESS_TOKEN }}
    
    - name: Test connection
      run: |
        jf rt ping

    - name: Setup build name and JFrog repository name
      run: |
        if [ -n "${{ env.BUILD_NAME }}" ]; then
          echo "BUILD_NAME=${{ env.BUILD_NAME }}" >> $GITHUB_ENV
        else
          echo "BUILD_NAME=${{ github.event.repository.name }}" >> $GITHUB_ENV
        fi

        if [ -n "${{ env.JFROG_REPO_NAME }}" ]; then
          echo "JFROG_REPO_NAME=${{ env.JFROG_REPO_NAME }}" >> $GITHUB_ENV
        else
          echo "JFROG_REPO_NAME=${{ github.event.repository.name }}-npm-local-dev" >> $GITHUB_ENV
        fi

        if [ -n "${{ env.JFROG_SECURITY_REPO_NAME }}" ]; then
          echo "JFROG_SECURITY_REPO_NAME=${{ env.JFROG_SECURITY_REPO_NAME }}" >> $GITHUB_ENV
        else
          echo "JFROG_SECURITY_REPO_NAME=${{ github.event.repository.name }}-security-local" >> $GITHUB_ENV
        fi
    
    - name: Setup npm registry
      run: |
        jf npm-config \
          --repo-resolve=${{ env.JFROG_REMOTE_REPO_NAME }} \
          --repo-deploy=${{ env.JFROG_REPO_NAME }}
    
    - name: npm install
      run: |
        jf npm ci --build-name=${{ env.BUILD_NAME }} --build-number=${{ github.run_number }}
    
    - name: npm run lint
      run: |
        jf npm run lint --build-name=${{ env.BUILD_NAME }} --build-number=${{ github.run_number }}
        jf npm run format:check --build-name=${{ env.BUILD_NAME }} --build-number=${{ github.run_number }}
    
    - name: Verify JFrog Repositories Exist
      run: |
        echo "Checking if JFrog repository '${{ env.JFROG_REPO_NAME }}' exists..."
        if jf rt curl -XGET "/api/repositories/${{ env.JFROG_REPO_NAME }}" --silent --fail > /dev/null 2>&1; then
          echo "✓ Repository '${{ env.JFROG_REPO_NAME }}' exists"
        else
          echo "✗ ERROR: Repository '${{ env.JFROG_REPO_NAME }}' does not exist in JFrog Artifactory"
          echo "Please create the repository before publishing the package"
          exit 1
        fi

        echo "Checking if JFrog security repository '${{ env.JFROG_SECURITY_REPO_NAME }}' exists..."
        if jf rt curl -XGET "/api/repositories/${{ env.JFROG_SECURITY_REPO_NAME }}" --silent --fail > /dev/null 2>&1; then
          echo "✓ Repository '${{ env.JFROG_SECURITY_REPO_NAME }}' exists"
        else
          echo "✗ ERROR: Repository '${{ env.JFROG_SECURITY_REPO_NAME }}' does not exist in JFrog Artifactory"
          echo "Please create the security repository as a Generic repository type"
          exit 1
        fi

    - name: Generate package tarball path
      run: |
        PACKAGE_NAME=$(node -p "require('./package.json').name")
        PACKAGE_VERSION=$(node -p "require('./package.json').version")
        SHORT_SHA="${GITHUB_SHA:0:8}"
        ORIGINAL_TARBALL="${PACKAGE_NAME}-${PACKAGE_VERSION}.tgz"
        TARBALL_NAME="${PACKAGE_NAME}-${PACKAGE_VERSION}-${SHORT_SHA}.tgz"
        echo "ORIGINAL_TARBALL=${ORIGINAL_TARBALL}" >> $GITHUB_ENV
        echo "TARBALL_PATH=${TARBALL_NAME}" >> $GITHUB_ENV
        echo "Package tarball: ${TARBALL_NAME}"

    - name: Create package tarball
      run: |
        jf npm pack
        mv "${{ env.ORIGINAL_TARBALL }}" "${{ env.TARBALL_PATH }}"
        ls -lh ${{ env.TARBALL_PATH }}

    - name: Scan package for vulnerabilities
      run: |
        if ! jf audit \
          --format=table \
          --npm \
            --watches SecurityWatch \
            --fail; then
          echo "✗ ERROR: Vulnerabilities found in package"
          echo "Please fix the vulnerabilities before publishing the package"
          exit 1
        fi

    - name: Publish to JFrog Artifactory
      run: |
        jf rt upload "${{ env.TARBALL_PATH }}" "${{ env.JFROG_REPO_NAME }}/" \
          --build-name=${{ env.BUILD_NAME }} \
          --build-number=${{ github.run_number }} \
          --module=${{ env.BUILD_NAME }}

    - name: Attest package with GitHub
      id: attest
      uses: actions/attest-build-provenance@v3
      with:
        subject-path: '${{ env.TARBALL_PATH }}'

    - name: Create custom attestation with actor info
      id: attest-actor
      uses: actions/attest@v2
      with:
        subject-path: '${{ env.TARBALL_PATH }}'
        predicate-type: 'https://github.com/attestation/actor/v1'
        predicate: |
          {
            "actor": "${{ github.actor }}",
            "actorId": "${{ github.actor_id }}",
            "triggeredBy": "${{ github.event_name }}",
            "repository": "${{ github.repository }}",
            "repositoryOwner": "${{ github.repository_owner }}",
            "commit": "${{ github.sha }}",
            "ref": "${{ github.ref }}",
            "workflow": "${{ github.workflow }}",
            "workflowRef": "${{ github.workflow_ref }}",
            "runId": "${{ github.run_id }}",
            "runNumber": "${{ github.run_number }}",
            "runAttempt": "${{ github.run_attempt }}",
            "timestamp": "${{ github.event.head_commit.timestamp }}"
          }

    - name: Add attestation metadata to JFrog artifact
      run: |
        # Add properties to the uploaded artifact in JFrog
        ARTIFACT_PATH="${{ env.JFROG_REPO_NAME }}/${{ env.TARBALL_PATH }}"
        
        jf rt set-props "${ARTIFACT_PATH}" \
          "attestation.github.url=https://github.com/${{ github.repository }}/attestations;attestation.actor=${{ github.actor }};attestation.trigger=${{ github.event_name }};attestation.commit=${{ github.sha }};attestation.provenance.bundle=${{ steps.attest.outputs.bundle-path }};attestation.actor.bundle=${{ steps.attest-actor.outputs.bundle-path }};attestation.sigstore.enabled=true;security.repo=${{ env.JFROG_SECURITY_REPO_NAME }}"
        
        echo "✓ Attestation metadata added to artifact in JFrog"

    - name: Find CodeQL SARIF results
      id: sarif-info
      run: |
        SARIF_FILE=$(find codeql-results -name "*.sarif" -type f | head -n 1)
        if [ -z "$SARIF_FILE" ]; then
          echo "Error: No SARIF file found"
          exit 1
        fi
        echo "SARIF_FILE=$SARIF_FILE" >> $GITHUB_ENV
        echo "Found SARIF file: $SARIF_FILE"
        
        # Generate SARIF filename for JFrog
        SHORT_SHA="${GITHUB_SHA:0:8}"
        SARIF_JFROG_NAME="${{ env.BUILD_NAME }}-codeql-${{ github.run_number }}-${SHORT_SHA}.sarif"
        echo "SARIF_JFROG_NAME=$SARIF_JFROG_NAME" >> $GITHUB_ENV
        echo "JFrog SARIF name: $SARIF_JFROG_NAME"

    - name: Attest CodeQL SARIF results
      id: attest-codeql
      uses: actions/attest@v2
      with:
        subject-path: '${{ env.SARIF_FILE }}'
        predicate-type: 'https://github.com/attestation/codeql/v1'
        predicate: |
          {
            "scanType": "codeql",
            "language": "javascript",
            "queries": "security-and-quality",
            "repository": "${{ github.repository }}",
            "commit": "${{ github.sha }}",
            "ref": "${{ github.ref }}",
            "workflow": "${{ github.workflow }}",
            "runId": "${{ github.run_id }}",
            "runNumber": "${{ github.run_number }}",
            "timestamp": "${{ github.event.head_commit.timestamp }}",
            "resultsFile": "${{ env.SARIF_FILE }}"
          }

    - name: Upload CodeQL SARIF to JFrog
      run: |
        cp "${{ env.SARIF_FILE }}" "${{ env.SARIF_JFROG_NAME }}"
        
        jf rt upload "${{ env.SARIF_JFROG_NAME }}" "${{ env.JFROG_SECURITY_REPO_NAME }}/" \
          --build-name=${{ env.BUILD_NAME }} \
          --build-number=${{ github.run_number }} \
          --module=${{ env.BUILD_NAME }}-security
        
        echo "✓ CodeQL SARIF uploaded to JFrog security repository"

    - name: Add CodeQL attestation metadata to SARIF in JFrog
      run: |
        SARIF_ARTIFACT_PATH="${{ env.JFROG_SECURITY_REPO_NAME }}/${{ env.SARIF_JFROG_NAME }}"
        
        jf rt set-props "${SARIF_ARTIFACT_PATH}" \
          "scan.type=codeql;scan.language=javascript;attestation.codeql.bundle=${{ steps.attest-codeql.outputs.bundle-path }};attestation.github.url=https://github.com/${{ github.repository }}/attestations;attestation.commit=${{ github.sha }};attestation.sigstore.enabled=true;related.artifact=${{ env.TARBALL_PATH }};related.package.repo=${{ env.JFROG_REPO_NAME }}"
        
        echo "✓ CodeQL attestation metadata added to SARIF in JFrog"
        echo "✓ SARIF file location: ${SARIF_ARTIFACT_PATH}"

    - name: Link package to SARIF security artifact
      run: |
        # Add bidirectional link from package to its SARIF file
        ARTIFACT_PATH="${{ env.JFROG_REPO_NAME }}/${{ env.TARBALL_PATH }}"
        
        jf rt set-props "${ARTIFACT_PATH}" \
          "security.sarif.file=${{ env.SARIF_JFROG_NAME }};security.sarif.path=${{ env.JFROG_SECURITY_REPO_NAME }}/${{ env.SARIF_JFROG_NAME }};security.scan.type=codeql;security.scan.language=javascript;security.scan.attestation=${{ steps.attest-codeql.outputs.bundle-path }}"
        
        echo "✓ Package linked to SARIF security artifact"
        echo "✓ Package: ${ARTIFACT_PATH}"
        echo "✓ SARIF: ${{ env.JFROG_SECURITY_REPO_NAME }}/${{ env.SARIF_JFROG_NAME }}"

    - name: Publish build-info to JFrog
      run: |
        jf rt build-publish --collect-env --collect-git-info ${{ env.BUILD_NAME }} ${{ github.run_number }}